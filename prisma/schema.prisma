generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                Int                    @id @default(autoincrement())
  name              String
  email             String                 @unique
  password          String
  role              Role                   @default(USER)
  department        String?
  phoneNumber       String?
  lineId            String?
  profilePicture    String?
  profilePictureId  String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  lineOALink        LineOALink?
  loans             Loan[]
  notifications     Notification[]
  repairTickets     RepairTicket[]         @relation("RepairUserTickets")
  repairAssignments RepairTicketAssignee[]
  repairLogs        RepairTicketLog[]
  assigned          Ticket[]               @relation("AssignedTickets")
  tickets           Ticket[]               @relation("UserTickets")
  logs              TicketLog[]
  assignedHistory   RepairAssignmentHistory[] @relation("Assigner")
  receivedHistory   RepairAssignmentHistory[] @relation("Assignee")
}

// Ticket
model Ticket {
  id                 Int                @id @default(autoincrement())
  ticketCode         String             @unique
  title              String
  description        String
  problemCategory    ProblemCategory
  problemSubcategory ProblemSubcategory
  equipmentName      String
  equipmentId        String?
  location           String
  category           String
  priority           Priority
  status             TicketStatus       @default(OPEN)
  notes              String?
  requiredDate       String?
  guestName          String?
  guestEmail         String?
  guestPhone         String?
  guestDepartment    String?
  userId             Int?
  assignedTo         Int?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  attachments        Attachment[]
  assignee           User?              @relation("AssignedTickets", fields: [assignedTo], references: [id])
  user               User?              @relation("UserTickets", fields: [userId], references: [id])
  logs               TicketLog[]
}
// Attachment
model Attachment {
  id        Int      @id @default(autoincrement())
  ticketId  Int
  filename  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  createdAt DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model TicketLog {
  id        Int          @id @default(autoincrement())
  ticketId  Int
  status    TicketStatus
  comment   String?
  updatedBy Int
  createdAt DateTime     @default(now())
  ticket    Ticket       @relation(fields: [ticketId], references: [id])
  user      User         @relation(fields: [updatedBy], references: [id])
}

model Notification {
  id        Int                @id @default(autoincrement())
  userId    Int
  type      NotificationType
  status    NotificationStatus @default(UNREAD)
  title     String
  message   String
  ticketId  Int?
  actionUrl String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Loan {
  id                 Int        @id @default(autoincrement())
  itemName           String
  description        String?
  quantity           Int        @default(1)
  borrowDate         DateTime   @default(now())
  expectedReturnDate DateTime
  returnDate         DateTime?
  status             LoanStatus @default(BORROWED)
  borrowerName       String?
  borrowerDepartment String?
  borrowerPhone      String?
  borrowerLineId     String?
  userId             Int
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  borrowedBy         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LineOALink {
  id                 Int            @id @default(autoincrement())
  userId             Int            @unique
  lineUserId         String?
  displayName        String?
  pictureUrl         String?
  status             LineLinkStatus @default(PENDING)
  verificationToken  String?
  verificationExpiry DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LineNotification {
  id           Int                    @id @default(autoincrement())
  lineUserId   String
  type         String
  title        String
  message      String
  status       LineNotificationStatus @default(SENT)
  retryCount   Int                    @default(0)
  errorMessage String?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
}

model RepairTicket {
  id                      Int                    @id @default(autoincrement())
  ticketCode              String                 @unique
  reporterName            String
  reporterDepartment      String?
  reporterPhone           String?
  reporterLineId          String?
  problemCategory         ProblemCategory
  problemTitle            String
  problemDescription      String?
  location                String
  status                  RepairTicketStatus     @default(PENDING)
  urgency                 UrgencyLevel           @default(NORMAL)
  userId                  Int
  notes                   String?
  messageToReporter       String?                // ข้อความถึงผู้แจ้ง (แยกจาก notes ภายใน)
  estimatedCompletionDate DateTime?              // เวลาโดยประมาณที่จะเสร็จ
  scheduledAt             DateTime               @default(now())
  completedAt             DateTime?
  cancelledAt             DateTime?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  attachments             RepairAttachment[]
  user                    User                   @relation("RepairUserTickets", fields: [userId], references: [id], onDelete: Cascade)
  assignees               RepairTicketAssignee[]
  logs                    RepairTicketLog[]
  assignmentHistory       RepairAssignmentHistory[]
}


model RepairAttachment {
  id             Int          @id @default(autoincrement())
  repairTicketId Int
  filename       String
  fileUrl        String
  fileSize       Int
  mimeType       String
  createdAt      DateTime     @default(now())
  repairTicket   RepairTicket @relation(fields: [repairTicketId], references: [id], onDelete: Cascade)
}

model RepairTicketLog {
  id             Int                @id @default(autoincrement())
  repairTicketId Int
  status         RepairTicketStatus
  comment        String?
  updatedBy      Int
  createdAt      DateTime           @default(now())
  repairTicket   RepairTicket       @relation(fields: [repairTicketId], references: [id], onDelete: Cascade)
  user           User               @relation(fields: [updatedBy], references: [id])
}

model RepairTicketAssignee {
  id             Int          @id @default(autoincrement())
  repairTicketId Int
  userId         Int
  assignedAt     DateTime     @default(now())
  repairTicket   RepairTicket @relation(fields: [repairTicketId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([repairTicketId, userId])
}

model Department {
  id           Int      @id @default(autoincrement())
  name         String
  code         String   @unique
  description  String?
  location     String?
  contactEmail String?
  contactPhone String?
  headName     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model StockItem {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  quantity  Int      @default(0)
  category  String?
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  USER
  IT
  ADMIN
}

enum NotificationType {
  TICKET_CREATED
  TICKET_ASSIGNED
  TICKET_UPDATED
  TICKET_COMPLETED
  TICKET_REJECTED
  COMMENT_ADDED
  STATUS_CHANGED
}

enum NotificationStatus {
  UNREAD
  READ
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum RepairTicketStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  WAITING_PARTS
  COMPLETED
  CANCELLED
}

model RepairAssignmentHistory {
  id             Int          @id @default(autoincrement())
  repairTicketId Int
  repairTicket   RepairTicket @relation(fields: [repairTicketId], references: [id], onDelete: Cascade)
  action         String
  assignerId     Int?
  assigner       User?        @relation("Assigner", fields: [assignerId], references: [id])
  assigneeId     Int?
  assignee       User?        @relation("Assignee", fields: [assigneeId], references: [id])
  note           String?
  createdAt      DateTime     @default(now())
}

enum UrgencyLevel {
  NORMAL
  URGENT
  CRITICAL
}

enum ProblemCategory {
  HARDWARE
  SOFTWARE
  NETWORK
  PERIPHERAL
  EMAIL_OFFICE365
  ACCOUNT_PASSWORD
  OTHER
}

enum ProblemSubcategory {
  INTERNET_DOWN
  SLOW_CONNECTION
  WIFI_ISSUE
  MONITOR_BROKEN
  KEYBOARD_BROKEN
  MOUSE_BROKEN
  COMPUTER_CRASH
  INSTALLATION
  LICENSE
  PERFORMANCE
  JAM
  NO_PRINTING
  CARTRIDGE
  INSTALLATION_AC
  MALFUNCTION_AC
  POWER_DOWN
  LIGHT_PROBLEM
  OTHER
}

enum LoanStatus {
  BORROWED
  RETURNED
  OVERDUE
  LOST
}

enum LineLinkStatus {
  PENDING
  VERIFIED
  UNLINKED
}

enum LineNotificationStatus {
  SENT
  FAILED
  READ
}
